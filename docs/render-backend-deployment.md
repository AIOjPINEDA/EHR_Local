# Render Backend Deployment Guide

## Overview
This document explains how to deploy the Consultamed backend to Render using the provided configuration.

## Prerequisites
1. A Render account
2. The render.yaml configuration file in the root directory
3. The backend/render_build.sh script

## Deployment Steps

### 1. Initial Deployment (Without Database)

1. Go to Render Dashboard
2. Click "New Blueprint"
3. Connect your repository
4. Render will automatically detect the render.yaml file
5. The backend will deploy with a temporary DATABASE_URL

### 2. Create the Database

1. In Render Dashboard, create a new PostgreSQL database
2. Name it `consultamed-db` (or update render.yaml accordingly)
3. Choose the Free plan for MVP
4. Wait for the database to be provisioned

### 3. Update DATABASE_URL

**CRITICAL**: Once the database is created, you must update the environment variable:

1. Go to your backend service in Render
2. Go to "Environment" tab
3. Find the RENDER_DATABASE_URL variable
4. Replace the temporary value with your actual database URL
5. The format should be: `postgresql+asyncpg://user:password@host:port/database`
6. Redeploy the service

## Environment Variables

### Required Variables
- `RENDER_DATABASE_URL`: PostgreSQL connection string (MUST be updated after DB creation)
- `DATABASE_MODE`: Set to `render_cloud` for Render deployments
- `JWT_SECRET_KEY`: Auto-generated by Render
- `JWT_ALGORITHM`: HS256
- `ACCESS_TOKEN_EXPIRE_MINUTES`: 60 (1 hour for production)
- `FRONTEND_URL`: Your frontend URL on Render
- `ENVIRONMENT`: production
- `DEBUG`: false

### Optional Variables
- `SUPABASE_URL`: If using Supabase for additional features
- `SUPABASE_ANON_KEY`: Supabase anonymous key
- `SUPABASE_SERVICE_KEY`: Supabase service key

## Build Process

The render_build.sh script:
1. Installs system dependencies for WeasyPrint
2. Installs Python dependencies from requirements.txt
3. Verifies WeasyPrint installation
4. Prepares the application for production

## Start Command

The application starts with Gunicorn using Uvicorn workers:
```bash
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT
```

## Verification

After deployment, verify:
1. Health endpoint: `https://your-backend.onrender.com/health`
2. API docs: `https://your-backend.onrender.com/docs`
3. JWT authentication is working
4. PDF generation is functional

## Troubleshooting

### Common Issues
1. **Build fails on WeasyPrint**: Check system dependencies in render_build.sh
2. **Database connection errors**: Verify DATABASE_URL format and database status
3. **502 errors**: Check application logs for startup errors

### Database URL Format
The correct format is:
```
postgresql+asyncpg://username:password@host:port/databasename
```

Note that Render uses `asyncpg` driver, not standard `psycopg2`.

## Security Notes

1. JWT_SECRET_KEY is generated automatically by Render
2. ACCESS_TOKEN_EXPIRE_MINUTES is set to 60 (1 hour) for production
3. DEBUG is set to false
4. All endpoints require authentication except /health and /docs

## Next Steps

1. Deploy the backend using this guide
2. Create and configure the database
3. Update DATABASE_URL environment variable
4. Verify all endpoints are working
5. Proceed with frontend deployment